pico-8 cartridge // http://www.pico-8.com
version 18
__lua__

obj = {}
rock = {}
rocks = {}
mover = {}
f = 1


obj.new = function(init)
   init = init or {}
   
   local self = {}
   self.x = init.x or 40
   self.y = init.y or 10
   self.w_px = init.w_px or 16
   self.h_px = init.h_px or 16
   self.w_sprite = init.w_sprite or 2
   self.h_sprite = init.h_sprite or 2
   self.sprite = init.sprite or 2
   self.draw = init.draw or obj.draw
   self.move = init.move
   return self
end

obj.draw = function(self)
   spr(self.sprite, self.x, self.y, self.w_sprite, self.h_sprite)
end

mover.move = function(self)
   local dx = 0
   local dy = 0
   
   if btn(0) then dx = -1 end
   if btn(1) then dx = 1 end
   if btn(2) then dy = -1 end
   if btn(3) then dy = 1 end

   for rock in all(rocks) do
      if box_hit(self.x+dx, self.y,
		 self.w_px, self.h_px,
		 rock.x, rock.y,
		 rock.w_px, rock.h_px) then
	 dx = 0
      end

      if box_hit(self.x, self.y+dy,
		 self.w_px, self.h_px,
		 rock.x, rock.y,
		 rock.w_px, rock.h_px) then
	 dy = 0	   
      end
   end

   if dx != 0 then
      if map_hit(self.x+dx,
      		 self.y,
      		 self.w_px,
      		 self.h_px) then
	 dx = 0
      end
   end
   if dy != 0 then
      if map_hit(self.x,
   		 self.y+dy,
   		 self.w_px,
   		 self.h_px) then
   	 dy = 0
      end
   end
   
   self.x += dx
   self.y += dy
   
end

box_hit = function(x1,y1,
		   w1,h1,
		   x2,y2,
		   w2,h2)
  
  local hit=false
  local xd=abs((x1+(w1/2))-(x2+(w2/2)))
  local xs=w1*0.5+w2*0.5
  local yd=abs((y1+(h1/2))-(y2+(h2/2)))
  local ys=h1/2+h2/2
  if xd<xs and 
     yd<ys then 
    hit=true 
  end
  
  return hit
end

function map_hit(x,y,w,h)
  local hit=false
  for i=x,x+w do
    if (fget(mget(i/8,y/8))>0) or
         (fget(mget(i/8,(y+h)/8))>0) then
          hit=true
    end
  end
  
  for i=y,y+h,h do
    if (fget(mget(x/8,i/8))>0) or
         (fget(mget((x+w)/8,i/8))>0) then
          hit=true
    end
  end
  
  return hit
end


function _init()
   rocks = {obj.new({x = 100, y = 100}), obj.new({x = 50, y = 50}),
	    obj.new({x = 80, y = 60}), obj.new({x = 110, y = 30})}
   mover = obj.new({x = 20,
   		    y = 20,
   		    sprite = 1,
   		    w_px = 8,
   		    h_px = 8,
   		    w_sprite = 1,
   		    h_sprite = 1,
   		    move = mover.move
   })
end

function _update60()
   mover:move()
end

function _draw()
   cls()
   map(0,0)
   for rock in all(rocks) do
      rock:draw()
   end
   mover:draw()
end
__gfx__
0000000099999999aaaaaaaaaaaaaaaafffffffff00000000000000fffffffff00000000ffffffffffffffff0000000ff0000000000000000000000000000000
0000000099999999aaaaaaaaaaaaaaaafffffffff00000000000000f0000000000000000f00000000000000f0000000ff0000000000000000000000000000000
0000000099999999aaaaaaaaaaaaaaaafffffffff00000000000000f0000000000000000f00000000000000f0000000ff0000000000000000000000000000000
0000000099999999aaaaaaaaaaaaaaaafffffffff00000000000000f0000000000000000f00000000000000f0000000ff0000000000000000000000000000000
0000000099999999aaaaaaaaaaaaaaaafffffffff00000000000000f0000000000000000f00000000000000f0000000ff0000000000000000000000000000000
0000000099999999aaaaaaaaaaaaaaaafffffffff00000000000000f0000000000000000f00000000000000f0000000ff0000000000000000000000000000000
0000000099999999aaaaaaaaaaaaaaaafffffffff00000000000000f0000000000000000f00000000000000f0000000ff0000000000000000000000000000000
0000000099999999aaaaaaaaaaaaaaaafffffffff00000000000000f00000000fffffffff00000000000000fffffffffffffffff000000000000000000000000
0000000000000000aaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000aaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000aaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000aaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000aaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000aaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000aaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000aaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0eeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00eeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
eeeeee0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0eee00ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0eeeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00eeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000001000101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000002000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
